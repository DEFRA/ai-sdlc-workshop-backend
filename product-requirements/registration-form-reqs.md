# Product Requirements (PRD)

## Context

The "Register Surplus Forms" service captures three answers from a short GOV.UK-style survey and stores them once the user presses **"Accept and send"** on the *Check your answers* page.
A lightweight RESTful API (Node 14 +, Express 4 +, SQLite 3) will:

* persist each completed survey in a single **registrations** table
* expose
  `POST /api/v1/registrations` – create one row (called from the Check-answers page)
  `GET  /api/v1/registrations/:id` – fetch one row by its generated id

No update, delete or list endpoints are required for this release.

---

## Data model (JSON representation / SQLite schema)

| Field               | Type                                   | Notes                                                                                  |
| ------------------- | -------------------------------------- | -------------------------------------------------------------------------------------- |
| `id`                | `uuid` **PK**                          | `uuidv4` created by API, returned to frontend                                          |
| `referenceNumber`   | `char(8)`                              | Format `/^[A-Z0-9]{8}$/`, e.g. **HDJ2123F** – generated by API for confirmation screen |
| `formType`          | `string`                               | enum: `AD01`, `B07`, `K432`, `D243`, `OTHER`                                           |
| `formTypeOtherText` | `string nullable`                      | only sent when `formType === "OTHER"`                                                  |
| `penColourNotUsed`  | `string`                               | enum: `BLUE`, `BLACK`, `RED`, `GREEN`, `OTHER`                                         |
| `guidanceRead`      | `string`                               | enum: `YES`, `LOOKED_AT_NOW`, `NO`                                                     |
| `createdAt`         | `datetime` default `CURRENT_TIMESTAMP` | audit only                                                                             |

The frontend sends exactly the keys above inside one JSON document; any additional properties are rejected with **422**.

---

## Feature 1. Persist a registration (POST)

A single feature covering validation, persistence, id & reference generation.

### Story 1.1 – Create registration record

*Type:* **backend API**

*As a* SPA client
*I want* to POST the completed survey answers to `/api/v1/registrations`
*so that* the data is validated, stored and an id/reference is returned for the confirmation page.

**Acceptance criteria**

```
Given  valid JSON that satisfies the schema
When   I POST it to /api/v1/registrations
Then   the API responds 201
  And   the body contains { id, referenceNumber }
  And   a row exists in sqlite3 matching the payload
```

```
Given  an unknown or extra property
When   I POST the document
Then   the response is 422 with a JSON array of error messages
```

```
Given  formType === "OTHER"
And    formTypeOtherText is empty
When   I POST
Then   the response is 422
```

```
Given  a network / DB failure
When   I POST
Then   the response is 503 with problem-json
```

**Architecture notes**

* **Path:** `POST /api/v1/registrations`
* **Validation:** `ajv@8` JSON-schema – declarative enums & required / dependencies
  (dependency rule enforces `formTypeOtherText` presence)
* **Id:** `uuid.v4()`
* **Reference:** 8-char base-36 random, collision-checked in SQL:
  `SELECT 1 FROM registrations WHERE referenceNumber=?` loop max 5
* **SQL:** parameterised insert

  ```sql
  INSERT INTO registrations
  (id,referenceNumber,formType,formTypeOtherText,
   penColourNotUsed,guidanceRead)
  VALUES (?,?,?,?,?,?)
  ```
* **Transaction boundary:** one autocommit statement – keeps it simple.
* **Response example**

  ```json
  {
    "id": "2b3c55b8-a480-4f2e-bf0d-8d3f9e2bf4be",
    "referenceNumber": "HDJ2123F"
  }
  ```
* **Dependency:** Story 2.1 (schema & migrations) must land first.

---

## Feature 2. Retrieve a registration (GET)

### Story 2.1 – Return previously stored data

*Type:* **backend API**

*As an* admin tool or future frontend flow
*I want* to GET `/api/v1/registrations/:id`
*so that* I can view the answers that were submitted.

**Acceptance criteria**

```
Given  a known id in the database
When   I GET /api/v1/registrations/{id}
Then   the response is 200
  And   the body is the full JSON record (except internal timestamps)
```

```
Given  an unknown id
When   I GET /api/v1/registrations/{id}
Then   the response is 404 with problem-json { title: "Not Found" }
```

**Architecture notes**

* **Path:** `GET /api/v1/registrations/:id([0-9a-f-]{36})`
* **SQL:** `SELECT id, referenceNumber, formType, formTypeOtherText, penColourNotUsed, guidanceRead FROM registrations WHERE id=?`
* **Security:** no auth for now (service is internal), add API key header when required.
* **Perf:** single row lookup on PK (fast).
